<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Withdrawal Page</title>    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f9f9f9;
            color: #333;
        }

        header {
            background-color: #00796B;
            color: #fff;
            padding: 1rem;
            text-align: center;
        }

        .container {
            max-width: 500px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        h2, h3 {          
           text-align: center;
            margin-bottom: 20px;
        }

        .balance-container {
            font-size: 1.2rem;
            text-align: center;
            margin-bottom: 20px;
        }

        .withdraw-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        label {
            font-weight: bold;
        }

        input, select {
            padding: 10px;
            font-size: 1rem;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        button {
            padding: 12px;
            font-size: 1rem;
            background-color: #00796B;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }

        button:hover {
            background-color: #004D40;
        }

        .loading {
            text-align: center;
            display: none;
            font-size: 1rem;
        }

        .history-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
            font-size: 10px;
        }

        .history-table th, .history-table td {
            border: 1px solid #ddd;
            padding: 8px;
            Font-size: 10px;
            
        }

        .history-table th {
            background-color: #00796B;
            color: white;
        }
    </style>
</head>
<body>
    <header>
        <h4>Welcome to Your FWF Campany Withdrawal Page</h4>
       <span> <img src="wi.png" style="width: 50px; height: 50%;"></span><i>Bank Transfer 7% Network fee, </i>
    </header>
    
    <div class="container">
        <h2>Welcome, <span id="userFullName"></span> ðŸ‘‹</h2>
        <div class="balance-container">
            Balance: â‚¦<span id="userBalance">0.00</span>
        </div>
        <hr>

        <h3>Make a Withdrawal</h3>
        <form class="withdraw-form" id="withdrawForm">
            <label for="amount">Amount:</label>
            <input type="number" id="amount" placeholder="Enter amount (min â‚¦500)" min="500" required>

            <label for="bank">Bank Name:</label>
        <select id="bank" required>
                  
    <option value="">Select Bank</option>
    <option value="058">GTBank</option>
    <option value="044">Access Bank</option>
    <option value="035">Wema Bank</option>
    <option value="585">OPay</option>
    <option value="050">Ecobank</option>
    <option value="070">Fidelity Bank</option>
    <option value="011">First Bank</option>
    <option value="214">FCMB</option>
    <option value="030">Heritage Bank</option>
    <option value="301">Jaiz Bank</option>
    <option value="082">Keystone Bank</option>
    <option value="076">Polaris Bank</option>
    <option value="221">Stanbic IBTC Bank</option>
    <option value="068">Standard Chartered Bank</option>
    <option value="232">Sterling Bank</option>
    <option value="100">SunTrust Bank</option>
    <option value="032">Union Bank</option>
    <option value="033">UBA</option>
    <option value="215">Unity Bank</option>
    <option value="057">Zenith Bank</option>
    <option value="101">Providus Bank</option>
    <option value="526">Parallex Bank</option>
    <option value="00103">Globus Bank</option>
    <option value="102">Titan Trust Bank</option>
    <option value="50515">Moniepoint MFB</option>
    <option value="999991">PalmPay</option>   
    <option value="801">Abbey Mortgage Bank</option>
    <option value="063">Access Bank (Diamond)</option>
    <option value="035A">ALAT by WEMA</option>
    <option value="023">Citibank Nigeria</option>
    <option value="559">Coronation Merchant Bank</option>
    <option value="501">FSDH Merchant Bank Limited</option>
    <option value="50211">Kuda Bank</option>
    <option value="303">Lotus Bank</option>
    <option value="125">Rubies MFB</option>
</select>


            <label for="accountNumber">Bank Account Number:</label>
            <input type="text" id="accountNumber" placeholder="Enter account number" required>

            <button type="submit">Transfer</button>
        </form>
        <div class="loading" id="loading">
            Loading, please wait...
        </div>

        <h3>Withdrawal History</h3>
        <table class="history-table" id="historyTable">
            <thead>
                <tr>
                    <th>Amount</th>
                    <th>Bank</th>
                    <th>Account</th>
                    <th>Name</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody>
               
            </tbody>
        </table>
    </div>

    <style>
    #email-icon {
            position: fixed;
            bottom: 20px;
            right: 2px;
            width: 70px;
            height: 70px;
            Top: 220px;
            
            border-radius: 50%;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        #email-icon:hover {
            transform: scale(1.1);
        }

        #email-icon img {
            width: 70px;
            height: 70px;
            Border-radius: 50%;
        }
        
        footer {
    text-align: center;
    background-color: #00796B;
    color: #ecf0f1;
    padding: 20px;
    font-size: 1rem;
    border-top: 3px solid rgba(255, 255, 255, 0.1);
}
</style>

<div id="email-icon">
    <img src="sup.png" alt="Support Icon">
</div>

<script>
    document.getElementById('email-icon').addEventListener('click', function () {
        const email = 'fruitwealthfarming@gmail.com';
        const subject = encodeURIComponent("Customer Inquiry from Fruit Wealth Farming Invest");
        const body = encodeURIComponent("Dear Fruit Wealth Farming,\n\nI have questions regarding your services. Please assist.\n\nThank you.");
        const mailtoUrl = `mailto:${email}?subject=${subject}&body=${body}`;
        window.location.href = mailtoUrl;
    });
</script>
<footer>
        <p>&copy; Fruit Wealth Farming. All rights reserved.</p>
    </footer>
           
 <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getDatabase, ref, get, update, push } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

// Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyBtwsxKGlpX-ofm-yE4o6_5FNYyKFy7X7w",
    authDomain: "fruit-wealth-farming.firebaseapp.com",
    databaseURL: "https://fruit-wealth-farming-default-rtdb.firebaseio.com",
    projectId: "fruit-wealth-farming",
    storageBucket: "fruit-wealth-farming.appspot.com",
    messagingSenderId: "417203511096",
    appId: "1:417203511096:web:1ecaca3d0a705a8c16ebcd",
    measurementId: "G-BZFLHB4KM2",
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth();
const database = getDatabase();

// Fetch PAYSTACK_SECRET_KEY from server
let PAYSTACK_SECRET_KEY = "";
async function fetchPaystackKey() {
    try {
        const response = await fetch("/api/get-paystack-secret-key.js");
        const data = await response.json();
        PAYSTACK_SECRET_KEY = data.key;
        if (!PAYSTACK_SECRET_KEY) {
            throw new Error("Paystack key not retrieved!");
        }
        console.log("Paystack key loaded successfully.");
    } catch (error) {
        console.error("Error fetching Paystack key:", error);
    }
}
await fetchPaystackKey();

// DOM Elements
const withdrawForm = document.getElementById("withdrawForm");
const userFullName = document.getElementById("userFullName");
const userBalanceElement = document.getElementById("userBalance");
const loadingElement = document.getElementById("loading");
const historyTable = document.getElementById("historyTable").querySelector("tbody");
const pinForm = document.getElementById("pinForm");
const userPinInput = document.getElementById("userPin");

// Global Variables
let currentUserId = null;
let currentBalance = 0;

// Authentication State Listener
onAuthStateChanged(auth, (user) => {
    if (user) {
        currentUserId = user.uid;
        loadUserData();
        loadWithdrawalHistory();
    } else {
        alert("User not authenticated! Please log in.");
    }
});

// Load User Data
function loadUserData() {
    const userRef = ref(database, `users/${currentUserId}`);
    get(userRef).then((snapshot) => {
        if (snapshot.exists()) {
            const data = snapshot.val();
            userFullName.textContent = data.fullName;
            currentBalance = parseFloat(data.userBalance || 0);
            userBalanceElement.textContent = currentBalance.toFixed(2);
        }
    });
}

// Load Withdrawal History
function loadWithdrawalHistory() {
    const historyRef = ref(database, `users/${currentUserId}/historyWithdrawal`);
    get(historyRef).then((snapshot) => {
        if (snapshot.exists()) {
            historyTable.innerHTML = "";
            const history = snapshot.val();
            Object.values(history).forEach((entry) => {
                const row = `<tr>
                    <td>â‚¦${entry.amount}</td>
                    <td>${entry.bankName}</td>
                    <td>${entry.accountNumber}</td>
                    <td>${entry.accountName}</td>
                    <td>${entry.date}</td>
                </tr>`;
                historyTable.insertAdjacentHTML("beforeend", row);
            });
        }
    });
}

// Add Audio for Alerts
const alertSound = new Audio("od.mp3");

// Function to Play Alert Sound
function playAlertSound() {
    alertSound.play();
}

// Handle Withdraw Form Submit
withdrawForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const amount = parseFloat(document.getElementById("amount").value);
    const bankCode = document.getElementById("bank").value;
    const accountNumber = document.getElementById("accountNumber").value;

    if (amount < 500) {
        playAlertSound();
        alert("Minimum withdrawal is â‚¦500.");
        return;
    }
    if (amount > currentBalance) {
        playAlertSound();
        alert("Insufficient balance.");
        return;
    }

    // Show loading animation
    loadingElement.style.display = "block";

    try {
        // Verify Bank Account using Paystack
        const accountName = await verifyBankAccount(accountNumber, bankCode);
        const bankName = getBankName(bankCode);

        // Confirm Transfer
        playAlertSound();
        const confirmTransfer = confirm(
            `Are you sure you want to transfer â‚¦${amount} to ${accountName} (${bankName} - ${accountNumber})?`
        );

        if (!confirmTransfer) {
            loadingElement.style.display = "none";
            return;
        }

        // Show PIN Form for confirmation
        pinForm.style.display = "block";
        pinForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const pin = userPinInput.value;

            // Verify PIN from Firebase
            const pinRef = ref(database, `users/${currentUserId}/transferP`);
            get(pinRef).then(async (snapshot) => {
                if (snapshot.exists()) {
                    const storedPin = snapshot.val();
                    if (storedPin === pin) {
                        // Deduct 7% Fee
                        const netAmount = amount - (amount * 0.07);

                        // Process Transfer
                        const transferSuccess = await processTransfer(accountNumber, bankCode, netAmount, accountName);

                        if (transferSuccess) {
                            updateBalanceAndHistory(amount, accountName, accountNumber, bankCode);
                            playAlertSound();
                            alert("Withdrawal Successful!");
                        } else {
                            playAlertSound();
                            alert("Transfer failed Network error, please try again later.");
                        }
                    } else {
                        playAlertSound();
                        alert("PIN is not correct.");
                    }
                } else {
                    playAlertSound();
                    alert("PIN not defined.");
                }
            });
        });

    } catch (error) {
        console.error(error);
        playAlertSound();
        alert("Error processing withdrawal. Please check details and try again.");
    } finally {
        loadingElement.style.display = "none";
    }
});

// Verify Bank Account
async function verifyBankAccount(accountNumber, bankCode) {
    const response = await fetch(`https://api.paystack.co/bank/resolve?account_number=${accountNumber}&bank_code=${bankCode}`, {
        headers: { Authorization: `Bearer ${PAYSTACK_SECRET_KEY}` },
    });
    const data = await response.json();
    if (!data.status) throw new Error(data.message || "Invalid account details, check and try again.");
    return data.data.account_name;
}

// Process Transfer
async function processTransfer(accountNumber, bankCode, amount, accountName) {
    const response = await fetch("https://api.paystack.co/transfer", {
        method: "POST",
        headers: {
            Authorization: `Bearer ${PAYSTACK_SECRET_KEY}`,
            "Content-Type": "application/json",
        },
        body: JSON.stringify({
            source: "balance",
            amount: Math.round(amount * 100), // Convert to kobo
            recipient: {
                type: "nuban",
                name: accountName,
                account_number: accountNumber,
                bank_code: bankCode,
                currency: "NGN",
            },
        }),
    });
    const data = await response.json();
    return data.status;
}

// Update Balance and History
function updateBalanceAndHistory(amount, accountName, accountNumber, bankCode) {
    const newBalance = currentBalance - amount;
    const userRef = ref(database, `users/${currentUserId}`);

    update(userRef, { userBalance: newBalance });

    const historyRef = ref(database, `users/${currentUserId}/historyWithdrawal`);
    push(historyRef, {
        amount: amount.toFixed(2),
        bankName: getBankName(bankCode),
        accountNumber,
        accountName,
        date: new Date().toLocaleString(),
    });

    userBalanceElement.textContent = newBalance.toFixed(2);
    loadWithdrawalHistory();
}

// Get Bank Name from Code
function getBankName(code) {
    const banks = {
        "058": "GTBank",
        "044": "Access Bank",
        "035": "Wema Bank",
        "585": "OPay",
        "050": "Ecobank",
        "070": "Fidelity Bank",
        "011": "First Bank",
        "214": "FCMB",
        "030": "Heritage Bank",
        "301": "Jaiz Bank",
        "082": "Keystone Bank",
        "076": "Polaris Bank",
        "221": "Stanbic IBTC Bank",
        "068": "Standard Chartered Bank",
        "232": "Sterling Bank",
        "100": "SunTrust Bank",
        "032": "Union Bank",
        "033": "UBA",
        "215": "Unity Bank",
        "057": "Zenith Bank",
        "101": "Providus Bank",
        "526": "Parallex Bank",
        "00103": "Globus Bank",
        "102": "Titan Trust Bank",
        "50515": "Moniepoint MFB",
        "999991": "PalmPay",               
    "801": "Abbey Mortgage Bank",
    "063": "Access Bank (Diamond)",
    "035A": "ALAT by WEMA",
    "023": "Citibank Nigeria",
    "559": "Coronation Merchant Bank",
    "501": "FSDH Merchant Bank Limited",
    "50211": "Kuda Bank",
        "303": "Lotus Bank",
        "125": "Rubies MFB"
    };
    return banks[code] || "Unknown Bank";
}
</script>
</body>
</html>
